---
title: "Living on the edge: crop boundary effects on canola and wheat yields in Alberta"
author:
  - name: Samuel V. J. Robinson
    email: samuel.robinson@ucalgary.ca
    affiliation: University of Calgary
    footnote: 1
  - name: Lan H. Nguyen
    email: hoanglan.nguyen@ucalgary.ca
    affiliation: University of Calgary
  - name: Paul Galpern
    email: paul.galpern@ucalgary.ca
    affiliation: University of Calgary
address:
  - code: University of Calgary
    address: 2500 University Drive NW, Calgary, AB
footnote:
  - code: 1
    text: "Corresponding Author"
date: "Fall 2021"
abstract: "`r paste(readLines('abstract.Rmd'), collapse = ' ')`"
keep_tex: true
keywords:
  - precision yield;
  - spillover;
  - landscape;
  
bibliography: yieldRefs.bib
geometry: "left=3cm,right=3cm,top=3cm,bottom=3cm"
output: 
  bookdown::pdf_book:
    base_format: rticles::elsevier_article
    toc: false
    fig_caption: true
csl: ecology-letters.csl    
header-includes:
  \makeatletter \def\ps@pprintTitle{  \let\@oddhead\@empty  \let\@evenhead\@empty  \def\@oddfoot{\centerline{\thepage}} \let\@evenfoot\@oddfoot} \makeatother
  \usepackage{float} \floatplacement{figure}{H} 
  \newcommand{\beginsupplement}{\setcounter{table}{0} \renewcommand{\thetable}{S\arabic{table}} \setcounter{figure}{0} \renewcommand{\thefigure}{S\arabic{figure}}}
  \usepackage{setspace}
  \linenumbers
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(knitr)
library(kableExtra)

source('../helperFunctions.R')

datSource <- read.csv('../Data/datSource.csv') %>% #Get data source
    mutate(modelComplete2=file.exists(paste0('.',modelPath2)))  #Has model2 already been run?

datSourceFinal <- datSource %>% filter(use) %>% filter(grepl('Wheat|Canola',crop)) 
yearsPerField <- datSourceFinal %>% count(field) %>% pull(n) #How many years of data at each unique location?

#Boundary lengths
bLengths <- read.csv('../Data/boundaryLengths.csv')
bNames <- c('Bare','Grassland','Other Crop','Shelterbelt','Standard','Wetland')

bLengthSummary <- bLengths %>% select(filename,contains('prop_')) %>% pivot_longer(contains('prop_')) %>% 
  mutate(name=gsub('prop_','',name)) %>% na.omit() %>% 
  group_by(name) %>% summarize(mean=mean(value),sd=sd(value),Nfields=sum(value>0)) %>% 
  mutate(name=bNames)

#Model smoother summaries
use <- with(datSource,use&modelComplete2&crop=='Canola')
paths <- paste0('.',gsub('modList.Rdata','results.txt',datSource$modelPath2))

canolaMods <- lapply(paths[use],function(x) getModelInfo(x)$smooths) %>% 
  set_names(nm=datSource$filename[use]) %>% 
  bind_rows(.id='field') %>% 
  mutate(pval=as.numeric(pval)) %>% 
  group_by(Smoother) %>% 
  summarize(meanP=mean(pval),maxP=max(pval),propSig=sum(pval<0.05)/n(),meanEDF=mean(edf),meanRef=mean(Ref.df))

use <- with(datSource,use&modelComplete2&crop=='Wheat')
wheatMods <- lapply(paths[use],function(x) getModelInfo(x)$smooths) %>% 
  set_names(nm=datSource$filename[use]) %>% 
  bind_rows(.id='field') %>% 
  mutate(pval=as.numeric(pval)) %>% 
  group_by(Smoother) %>% 
  summarize(meanP=mean(pval),maxP=max(pval),propSig=sum(pval<0.05)/n(),meanEDF=mean(edf),meanRef=mean(Ref.df))
rm(use,paths)

# #Average model parameters (mean/sd slopes with pArea)
# lapply(paths[use],function(x) getModelInfo(x)$params) %>% 
#   set_names(nm=datSource$filename[use]) %>% 
#   bind_rows(.id='field') %>% group_by(Parameter) %>% 
#   summarize(meanEst=mean(Estimate),Z=mean(Estimate/SE))


```

\newpage
\doublespacing

# Introduction

Intensive agricultural production has increased over the last 100 years, and agricultural land now makes up over a third of ice-free land on Earth
This has allowed increases in human population and increased (global) stability in production
However, this is not without cost, as higher-diversity non-crops are converted to lower-diversity crops, resulting in loss of habitat and overall biodiversity of non-target organisms
Maintaining both biodiversity and production in agroecosystems represents a seldom-considered goal of conservationists and agronomists, and hold the potential for win-win scenarios
Key to this is the preservation of semi-natural land (SNL), which represents the interface between crops and non-crops within agroecosystems

SNL in and around crops is important for both agricultural production and conservation
They are habitat for mobile organisms, and can therefore act as sources of ecosystem services such as pollination or pest control (@albrecht2020; @gardner2021)
They also can create microclimate effects that reduce extreme temperature, trap moisture, and reduce wind speed (@kort1988)
Unfortunately, most of the research is concentrated in Europe, and they tend to be less-studied on other continents
In particular, North American agroecosystems have larger fields, different crop varieties, and agronomic practices, all of which could negate or confound potential effects of SNL
  
<!-- - SNL has conflicting effects on crop yield because of ecosystem service provision as well as negative edge effects -->
SNL may affect yields at intermediate distances, depending on the spatial scale at which ecosystem services operate
Edge effects cause low yields at the edge of crops because of sparse or late seedling emergence, poor microclimate, and competition with weeds
At the same time, the centre of large fields will not receive ecosystem services if they decay with distance from edges (@kowalchuk1995)
For example, pollination services from central place foragers that nest in SNL but forage in crops drops rapidly with distance
Therefore, yield may be maximized at intermediate distances, where the ecosystem services cancel out negative edge effects (e.g. @vanVooren2017)
This suggests a ``goldilocks" field size, where negative edge effects are canceled out by ecosystem services
 
<!-- - Less-considered are ecosystem ``disservices", where weeds and pests  -->

<!-- - In North America, there are financial incentives to make fields large, homogeneous, and with simple geometry -->
    
Studies of SNL effects on crop yield also suffer from limited scope (e.g. few crop types) and small sample sizes, limiting inference and reducing generality (but see wheat study)
Meta-analyses have been the standard solution to this problem, but precision yield data holds enormous promise.
However, its use is limited for several reasons: 1) Lack of standardized formats between equipment types, 2) Sensor calibration required for field-level accuracy, and 3) unfamiliarity with spatial statistics.
Ecosystem services can influence both the mean and variability of yield in agroecosystems (@redhead2020).
Typically only averages (means) are considered, but higher stability (lower variance) in yield can also be valuable.
There are few studies of yield variability (only those with large datasets), but precision yield data opens up the possibility of modeling within-field variability, as well as average yield.
  
In this paper we ask:
  1. How does crop yield change with distance from the edge of field?
  2. Does this depend on type of field edge? 
  3. Is there an intermediate distance where yield is maximized or variance is minimized?

# Methods

## Data collection

Precision yield data were collected directly from farmers across Alberta.
Farmers were solicited for yield data through local agronomists, and we received `r nrow(datSource)` field-years of data from `r length(unique(datSource$grower))` growers across a total of `r length(unique(datSource$year))` years (`r min(unique(datSource$year))`-`r max(unique(datSource$year))`).
We converted raw data to a standard csv format using Ag Leader SMS.
`r round(100*sum(grepl('(Wheat|Canola)',datSource$crop))/nrow(datSource))`% of the crop types where either wheat (_Triticum aestivum_) or canola (_Brassica napus_), two of the most common crops in rotation in Alberta.
The remaining crop types had low replication, so we constrained our analysis to only field-years containing wheat (`r sum(datSourceFinal$crop=='Wheat')`) or canola (`r sum(datSourceFinal$crop=='Canola')`).
Individual fields contained between `r min(yearsPerField)` to `r max(yearsPerField)` years of data (mean: `r round(mean(yearsPerField),1)`), containing a total of `r round(sum(datSource$npoints)/1e6,1)` million data points.
  
Yield data is collected in rectangles of the same length as the data interval (distance = combine ground speed $\times$ interval, typically 1 second) and the same width as the combine header (5-7 m, adjusted to account for overlap with adjacent swaths).
We extracted the size of each polygon (m$^2$), dry yield (tonnes), and the spatial location, and the sequence of collection (1 - end of harvest)
Because of the large number of yield rectangles per field (30-800 thousand), we used the centroid of each polygon as its location, treating areal data as point data
Seeding and application rates were constant across fields, so we did not consider inputs in our analysis
We used dry yield (tonnes of seed/hectare minus recorded crop moisture) as our measure of crop yield
Precision yield data can be highly variable and is prone to extreme outliers (both positive and negative), especially when combine ground speeds are low and at the beginning of rows
Therefore, we filtered data that lay outside the 95th percentiles of yield within each field, values less than or equal to zero, and values outside of the 95th percentiles of ground speed.
Due to the large number of data at each field, we sub-sampled to 50,000 data points per field to reduce computation time.

Field boundaries were automatically digitized using buffers from the yield data locations, then manually checked using satellite imagery from Google Earth and classified land cover data from AAFC. 
Crop boundaries are flexible, and often change yearly depending on planting and emergence conditions (e.g. flooding during some years).
Ephemeral wetlands are flooded during some years, but consist mainly of grasses during dry years, and grass boundaries can change if fields are used for as haying or pasture during crop rotation.
This makes accurate and consistent classification of field boundaries difficult.
We defined the following general categories for field boundaries:
    1. Standard: grassy field edge, staging yard, or road right-of-way (grassy strip typically 5-10m wide) 
    2. Wetland: permanent wetland; borders are largely unchanged from year-to-year
    3. Shelterbelt: permanent windbreaks, shelterbelts, remnant forests, or shrublands
    4. Other crop: annual crop or pasture with little or no visible boundary between planted areas
    5. Bare: unplanted, fallow, flooded area, temporary wetland (only present for a single season), staging yard, oil and gas equipment, or road without a planted boundary
    6. Grassland: permanent seminatural grassland or pasture (not in rotation)
  
    <!-- STANDARD -->
    <!-- WETLAND -->
    <!-- SHELTERBELT -->
    <!-- OTHERCROP -->
    <!-- BARE -->
    <!-- GRASSLAND -->
    
## Analysis

Yield data from each field contains both random and systematic errors that must be modeled in order to reveal underlying changes in yield.
We fit an additive model of the effect of boundary distance on crop yield while accounting for within-field spatial variation and temporal variation in the data.
Crop yield can vary within a field due to soil conditions, moisture, seeding rates, herbicide application, and previous agricultural practices.      <!-- - such as strip farming -->
Ground speed is extremely important to yield monitor accuracy [@arslan2002], with low ground speed registering higher yields.
Sensor calibration can reduce combine-level bias (such as a combine recording consistently higher/lower yields across fields), this does not address sensor drift that occurs over time.
This may be caused by sensors accumulating debris during harvest (especially in canola, pers. comm. Trent Clark), leading to changes in accuracy and bias over time.
To model this, we fit the following model to each field-year of data:
  
  \begin{equation}
  \begin{split}
  \sqrt{yield} \sim & Normal (\mu, \sigma)\\
  \mu = & Intercept + log(\text{Polygon Size}) + f(\text{Edge Distance}, b=12)_i + \\
   & f(\text{Easting}, \text{Northing}, b=60) + f(\text{Sequence}, b=60) \\
  log(\sigma) =  & Intercept + log(\text{Polygon Size}) + f(\text{Edge Distance}, b=12)_i + \\
   & f(\text{Easting}, \text{Northing}, b=60) + f(\text{Sequence}, b=60) \\
  \end{split}
  \end{equation}
  
  - where:
  1. Polygon Size = distance traveled $\times$ width of header bar ($m^2$)
  2. Edge Distance = distance from field edge type _i_ (m)
  3. Easting, Northing = distance from centre of field (m)
  4. Sequence = order of harvest within field (1--N points)
  5. f(x,b) = penalized thin-plate regression spline, where _x_ is the predictor and _b_ is the number of basis dimensions
  
In addition to modeling edge effects (our variable of interest), this model also accounts for a) differences in harvested area, b) within-field spatial variation not related to edges, and d) shifts in combine accuracy during harvest.
Spatial or temporal variation can be modelled using a Gaussian Process Model (e.g. Kriging, SPDE Approximations) but this was computationally unfeasible with 50,000 data points per field.
Penalized splines offer a compromise, as they account for nonlinear ``wiggly" relationships in the same way as Gaussian processes but using a reduced number of dimensions and computation time.
The number of basis dimensions was checked with the _gam.check_ function from _mgcv_.
The relationship between polygon size and yield was modeled with a log-linear relationship with a single slope term, as this closely matched smoothed versions.
Because polygon size is not intuitive, we converted it into ground speed by regressing speed on distance traveled per polygon, then using this to back-calculate the ground speed for a given polygon size (given a fixed width of header). 
All models were fit in _R_ using the _mgcv_ library [version `r packageVersion('mgcv')`, @wood2017], and figures were created with _ggplot2_ and _ggpubr_ [versions `r packageVersion('ggplot2')`, @wickham2016; and `r packageVersion('ggpubr')`, @kassambara2020].
  
Despite the use of spatial and temporal smoothers, the residuals in most of the models displayed a large amount of spatial and temporal autocorrelation.
_Not really sure how we can get around this. In practice, this means that SEs for all coefficients are too small (i.e. we gathered 1000 points, but because they're spatially related, it's only equivalent to 100 points)._
<!-- - This is extremely common in precision yield data, but  -->

To consider results from all field-level models together, we fit models independent of each other and fit an "overall" smoother as averages of the field-level smoothers.
However, this does not account for uncertainty in the field-level smoothers, so we used an approach similar to bootstrapping of hierarchical mixed effects models:
  1. Extract single posterior sample (_rnorm_ in R) of smoother parameters from each field-level model using coefficient estimates and standard error
  2. Use posterior sample to create a new smoother from each field
  3. Fit new model of new smoothers from all fields, and save this "meta-smoother"
  4. Repeat 1000 times, and calculate coverage intervals (5-95% percentiles) on saved meta-smoothers
This gives coverage intervals (CIs) for the "average" smoother while accounting for field-level variability, and is conceptually similar to a meta-analysis.
Spatial variability was not averaged between fields because differences in field geometry make it impossible to compare fields.

# Results

## Field-level exanoke

The filtered data from each field still contained a large amount of variation, but the non-stationary additive models were able to reveal underlying yield patterns.
Figure \@ref(fig:examplePlot1)b shows the results from a single field to illustrate this, where areas of higher yield are clearly visible within the field.
Additionally, Figure \@ref(fig:examplePlot1)c shows that yield "patchiness" (standard deviation, SD) also varies within fields, with areas of higher and lower patchiness also clearly visible within fields.




```{r examplePlot1, echo=FALSE, fig.cap='Example output from a single field.', out.width='100%'}  
  include_graphics('../Figures/ExamplePlots/Trent_Clark JOHNSON 2014.png',dpi=NA)
```
```{r examplePlot1, echo=FALSE, fig.cap='Distance smoothers from a single field.', out.width='100%'}  
  include_graphics('../Figures/ExamplePlots/Trent_Clark JOHNSON 2014 Summary.png',dpi=NA)
```

## All canola fields

"Standard" (grassy border) was the most common boundary type, followed by "Shelterbelt" and "Other Crop" (Table \@ref(tab:boundaryTypes)).

```{r boundaryTypes, echo=FALSE, out.width='100%'}  
bLengthSummary %>% 
  kable(.,format='latex',caption='Mean and SD of proportion of boundary types across all fields, along with the number of fields bordered by at least some of the boundary type.',col.names = c('Type','Mean','SD','Number of Fields'),digits = c(1,4,4,1),escape = FALSE)
```

There was a strong negative effect combine ground speed on both the average and variability of canola yield.
At the field level, both yield average and yield variability (SD of yield) of yield were extremely spatially (average p-values: `r with(canolaMods,formatC(meanP[Smoother=='s(E,N)']))`, `r with(canolaMods,formatC(meanP[Smoother=='s.1(E,N)'],3))`) and temporally dependent (`r with(canolaMods,formatC(meanP[Smoother=='s(r)'],3))`, `r with(canolaMods,formatC(meanP[Smoother=='s.1(r)'],3))`), meaning that average and variability changed with location in the field, as well as sequentially during the harvest.
However, there was no difference in average or variability with harvest sequence when all fields were considered, meaning that combines did not appear to distort yield data from start to finish in any systematic way.

Average canola yield tended to increase with distance from Standard and Other Crop boundaries, leveling off at about 25 m (Figure \@ref(fig:canolaPlot) top row, Other crop and Standard panels); yield was approximately 0.1 T/ha (1.5 bu/ac) lower at the edge for both of these boundary types.
Interestingly, Shelterbelts were well-represented in the data (Table \@ref(tab:boundaryTypes)) but the negative edge effect was not strong (Figure \@ref(fig:canolaPlot) top row, Shelterbelt panel), indicating that they may provide better micro-climates for crops located near them.
Other boundary types were less common in the data and had correspondingly weaker effects on mean yield, but all showed a small negative edge effect.
Yield variability tended to decrease with distance from the edge of the field, indicating that edge effects contribute to yield "patchiness" as well as averages.
At Standard, Bare, and Wetland field boundaries, variability decreased until about 100 m, after which variablity was constant, while the pattern was less consistent in Grassland, Other Crop, and Shelterbelt. 

```{r canolaPlot, echo=FALSE, fig.cap='Field boundary effect on canola yield, accounting for the effect of combine speed, spatial variation, and harvest sequence. Upper panel represents mean yield, while the lower panel represents yield variation (i.e. "patchiness").', out.width='100%'}  
  include_graphics('../Figures/ModelSummary3a_canola.png',dpi=NA)
```

## All wheat fields

Similar to canola, there was a strong negative effect of ground speed on both yield and variability of wheat yield.


Average wheat yield (Figure \@ref(fig:wheatPlot)

```{r wheatPlot, echo=FALSE, fig.cap='Field boundary effect on canola yield, accounting for the effect of combine speed, spatial variation, and harvest sequence. Upper panel represents mean yield, while the lower panel represents yield variation (i.e. "patchiness").', out.width='100%'}  
  include_graphics('../Figures/ModelSummary3a_wheat.png',dpi=NA)
```

# Discussion

Discussion here

# Author Contributions

SVJR and PG conceived of the project.
SVJR collected data, conducted analysis, and wrote the manuscript.

# Acknowledgements

We thank Trent Clark, Dean Hubbard, Alvin French, and Kristina Polziehn for providing yield data for us, and providing insight on their yield data. 
We also thank Autumn Barnes and Keith Gabert of the Canola Council of Canada, and Laurel Thompson and JP Pettyjohn of Lakeland College for connecting us with farmers and agronomists. 
Funding for this research was provided by Ducks Unlimited Canada's Institute for Wetland and Waterfowl Research, the Alberta Canola Producers Commission, Manitoba Canola Growers Association, SaskCanola, the Alberta Biodiversity Monitoring Institute, and the Alberta Conservation Association.

# References {-}

<div id="refs"></div>

```{r child = 'supplemental.Rmd'}
```

